# Version 0.9.7_beta - Unicode Text Normalization & Character Mapping

**Release Date:** 2026-01-30  
**Type:** Feature Release (Beta)

## üöÄ Overview

This release solves a critical issue where machine learning models were producing incorrect or inconsistent results when processing hangout names and other text containing decorative Unicode characters (e.g., mathematical double-struck letters, Canadian Aboriginal Syllabics). The new Unicode normalization system converts fancy fonts to ASCII equivalents, enabling AI models to understand user input correctly.

## ‚ú® New Features & Improvements

### Unicode Text Normalization System

#### Automatic Decorative Character Conversion
- **Two-Phase Normalization**:
  1. **NFKD Standard Normalization**: Handles mathematical symbols and compatibility equivalents (e.g., `ùîª` ‚Üí `D`)
  2. **Custom Character Mapping**: Processes characters NFKD doesn't handle, like Canadian Aboriginal Syllabics (e.g., `·ïº` ‚Üí `H`)
- **Non-Destructive Processing**: Never removes characters - only maps decorative variants to ASCII equivalents
- **AI Model Integration**: Automatically normalizes text before sending to ML models

#### Character Mapping Storage
- **JSON-Based Configuration**: Character mappings stored in `data/specialCharacters.json`
- **Runtime Management**: Character mappings can be modified at runtime via the `!charmap` command
- **Auto-Initialization**: Creates `specialCharacters.json` from `specialCharacters.json_example` on first run if missing
- **Built-In Defaults**: Includes 50+ initial mappings for:
  - Mathematical Alphanumeric Symbols (U+1D400‚ÄìU+1D7FF)
  - Canadian Aboriginal Syllabics (U+1400‚ÄìU+167F)

### Character Mapping Management Command

#### New `!charmap` Admin Command
- **Owner-Only Access**: Requires OWNER role for security
- **List Mappings**: `!charmap list` - Display all character mappings grouped by ASCII equivalents
- **Add Mapping**: `!charmap add <fancy_char> <ascii_char>` - Create or update a character mapping
  - Validates that replacement is a standard ASCII character (A-Z, a-z, 0-9, common symbols, or space)
  - Prevents accidental circular or decorative replacements
- **Remove Mapping**: `!charmap remove <fancy_char>` - Remove an existing mapping
- **Test Normalization**: `!charmap test <text>` - Test text normalization without saving changes
- **Reload Configuration**: `!charmap reload` - Force reload mappings from disk after manual edits

#### Example Usage
```
!charmap list                    // View all current mappings
!charmap add ·ïº H                 // Add mapping for Canadian H
!charmap test ·ïºE·í™·í™O WO·ñá·í™·ó™      // Preview: "HELLO WORLD"
!charmap remove ·ïº                // Remove the H mapping
```

### Performance Optimization

#### ASCII Validation
- **Safe Replacements**: Validates that replacement characters are standard ASCII (printable range 32-126)
- **Prevents Circular Mappings**: Blocks attempts to map decorative characters to other decorative characters
- **User Feedback**: Clear error messages when invalid replacements are attempted
- **Standard ASCII Support**: Allows all standard characters: letters (A-Z, a-z), numbers (0-9), punctuation, and space

#### Caching System
- **In-Memory Mapping Cache**: Character mappings loaded once and cached for performance
- **Lazy Loading**: File only read when `normalizeText()` is first called
- **Cache Invalidation**: Can be cleared via `clearCache()` method or `!charmap reload` command

#### Intelligent Normalization
- **Non-String Passthrough**: Non-string inputs (null, undefined, numbers) passed through unchanged
- **Emoji Preservation**: Emojis and other non-text characters preserved during normalization
- **Empty String Handling**: Correctly handles empty strings without processing

## üîß Technical Details

### Service Architecture

#### Text Utilities Module (`src/lib/textUtils.js`)
```javascript
// Core normalization with NFKD + custom mappings
normalizeText(text)          // Normalize decorative Unicode to ASCII

// Character mapping management
loadMappings(forceReload)    // Load mappings from file with caching
saveMappings()               // Persist mappings to disk
addMapping(char, replacement)  // Add/update a mapping
removeMapping(char)          // Remove a mapping
getMappings()                // Get current mappings object
clearCache()                 // Force reload from disk next time
```

#### Machine Learning Service Integration
- **Automatic Normalization**: `askGoogleAI()` normalizes questions before processing
- **System Instruction Normalization**: Complete prompt (including hangout names) normalized before sending to AI
- **Transparent Processing**: Users see decorative characters in chat, AI processes clean ASCII equivalents

### Data Files

#### `data/specialCharacters.json`
- Auto-created from `data/specialCharacters.json_example` on first run
- JSON object: `{ "fancy_char": "ascii_equivalent", ... }`
- Fully editable at runtime via `!charmap` command
- Example mappings:
  ```json
  {
    "ùîª": "D",        // Mathematical D (double-struck)
    "·ïº": "H",        // Canadian H
    "·ñá": "R",        // Canadian R
    "·óØ": "W"         // Canadian W
  }
  ```

## üêõ Bug Fixes

- **ML Model Confusion Fixed**: AI models no longer produce garbled responses when processing decorative Unicode names
- **Hangout Name Recognition**: System instructions now properly understood by AI despite fancy fonts
- **Consistency Across Models**: All model variants (gemma-3-27b-it, gemma-3-12b-it) receive consistent, normalized input

## üìä Testing

### New Test Suites
- **`tests/lib/textUtils.test.js`** (25 tests)
  - Normalization accuracy with NFKD and custom mappings
  - Cache behavior and forced reloads
  - Mapping add/remove/list operations
  - Edge cases: null, undefined, non-strings, empty strings, emoji preservation

- **`tests/commands/handleCharmapCommand.test.js`** (14 tests)
  - All subcommands (list, add, remove, test, reload)
  - Error handling and validation
  - Command metadata and permission checks

### Compatibility
- ‚úÖ Existing tests: 905 passing
- ‚úÖ New tests: 39 passing
- ‚úÖ Total: 944 passing

## üìù Migration Notes

### Automatic Setup
- No manual configuration required
- `specialCharacters.json` automatically created from example template on first run
- Character normalization applied transparently to all AI interactions

### For Existing Installations
1. Pull latest code
2. Run tests to verify: `npm test`
3. Restart the bot - `specialCharacters.json` will be auto-created
4. No other changes needed

### Customization
To add your own character mappings:
1. Use `!charmap add <fancy_char> <ascii_char>` to add at runtime, OR
2. Edit `data/specialCharacters.json` directly and run `!charmap reload`

## üîó Related Files

- [Text Utilities](../src/lib/textUtils.js) - Normalization implementation
- [Character Mapping Command](../src/commands/Edit%20Commands/handleCharmapCommand.js) - `!charmap` command
- [Machine Learning Service](../src/services/machineLearningService.js) - ML integration
- [Character Mapping Example](../data/specialCharacters.json_example) - Default mappings template
