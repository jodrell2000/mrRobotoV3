# Version 0.9.6_beta - Gemma Model Migration & Enhanced ML System

**Release Date:** 2026-01-29  
**Type:** Feature Release (Beta)

‚ö†Ô∏è **Upgrading from 0.9.5_beta?** See the [migration guide](../migrations/0.9.5_beta_to_0.9.6_beta.md) for detailed upgrade instructions.

## üöÄ Overview

This release represents a significant change to the machine learning capabilities by migrating to Google's Gemma models, enabling continued free access to the Machine Learning functions. The system now includes dynamic model detection, refined token handling, improved prompt engineering, and enhanced song play history tracking.

## ‚ú® New Features & Improvements

### Machine Learning Model Upgrade

#### Gemma Model Support
- **Dynamic Model Discovery**: Service discovers available Gemma models from Google AI API at initialization
- **Primary Model Chain**: `gemma-3-27b-it` (27B) ‚Üí `gemma-3-12b-it` (12B) with automatic fallback
- **Flexible Architecture**: Automatically includes any additional Gemma models available via API
- **Cost Optimization**: Gemma models are free-tier compatible, maintaining full functionality without paid API usage
- **Performance**: Maintains or improves response quality with temperature-optimized generation (2.0 for creative, diverse responses)

#### Prompt Engineering Enhancement
- **Significantly Updated System Prompts**: Redesigned prompts specifically for Gemma model behavior and capabilities
- **Context-Aware Personality**: Improved time-based mood shifting and contextual responses
- **Better Instruction Following**: Enhanced prompt structure for consistent output formatting

### Token System Refinement

#### Gemini Turn Token Cleaning
- **Automatic Turn Token Removal**: Strips `<start_of_turn>user`, `<start_of_turn>model`, and `<end_of_turn>` tokens from responses
- **Clean Chat Integration**: Removed tokens prevent formatting artifacts in displayed messages
- **Historical Data Cleanup**: Existing conversation history sanitized on load

#### Built-In Token Expansion
- **currentTime**: Dynamic time formatting with timezone/locale support
- **timezone**: Configurable timezone (e.g., "America/Chicago")
- **locale**: Localization support (e.g., "en-US")
- **location**: Custom location token for personalization
- **MLPersonality**: AI personality derived from configured system prompts
- **Additional Tokens**: Song, DJ, and user-specific tokens for dynamic responses

### Song Play History Enhancement

#### Track History Database
- **Song Play Recording**: Automatic capture of:
  - Artist name and track title
  - DJ UUID and nickname
  - Vote counts (likes, dislikes, stars)
  - Play timestamp
- **Song Play History View**: New `song_play_history` database view provides:
  - Chronological song play records
  - DJ performance analytics
  - Vote tracking over time
- **Query Capabilities**: Retrieve recent songs, DJ-specific history, and historical trends

### Conversation History Optimization

#### Rolling Window Management
- **5-Pair Rolling History**: Maintains last 5 user/model message pairs for context
- **Dynamic Context Loading**: Last 3 pairs sent to new prompts for continuity without token bloat
- **Automatic Cleanup**: Oldest pairs discarded automatically when limit reached
- **Persistence**: Conversation history stored in `botConfig.json` for session continuity

### Time Formatting Fix

#### Midnight Hour Handling
- **24-Hour Format Correction**: Fixed edge case where `toLocaleTimeString()` returns "24:XX" for midnight hours
- **Automatic Conversion**: "24:XX" automatically converted to "00:XX" for correct midnight display
- **Locale-Aware**: Works across different timezone and locale configurations

## üîß Technical Details

### Service Architecture

#### MachineLearningService
```javascript
// Automatic Gemini token removal
cleanGeminiTokens(text) {
    // Removes turn markers from model responses
}

// Model fallback chain
tryModel(userMessage) {
    // Attempts primary, fallback 1, fallback 2 in sequence
}
```

#### TokenService Enhancements
```javascript
getCurrentTime() {
    // Returns timezone/locale-aware time with midnight correction
}

replaceTokens(template) {
    // Supports 14+ built-in and unlimited custom tokens
}
```

#### DatabaseService Song Tracking
```javascript
recordSongPlay(songData) {
    // Logs song with DJ info and vote counts
}

getRecentSongs(limit) {
    // Queries song_play_history view
}
```

## üìä Configuration Updates

### botConfig.json Structure
- `configuration.timezone`: Set to "America/Chicago" (customizable)
- `configuration.locale`: Set to "en-US" (customizable)
- `configuration.timeFormat`: "24" for 24-hour, "12" for 12-hour format
- `mlSystemPrompts`: Updated prompts for Gemma models with detailed personality definitions
- `mlConversationHistory`: Rolling 5-pair window of user/model messages
- `customTokens`: User-defined tokens like `{location}` for dynamic substitution

## üêõ Bug Fixes

- Fixed `{currentTime}` token displaying "24:XX" instead of "00:XX" for midnight hours
- Cleaned Gemini turn tokens from stored conversation history and responses
- Improved error handling in TokenService with fallback timezone support

## üîÑ Changed Behavior

- **ML Responses**: Now cleaner without Gemma/Gemini internal turn markers
- **Time Display**: Accurate midnight hour formatting in all timezone configurations
- **Conversation Context**: Uses optimized 3-pair window for new prompts instead of full history
- **Model Selection**: Dynamically discovers and chains Gemma models from API; defaults to `gemma-3-27b-it` ‚Üí `gemma-3-12b-it`
- **Temperature Setting**: Increased to 2.0 for more creative and diverse responses (was 0.9)

## ‚öôÔ∏è System Requirements

No new dependencies required. Uses existing Google Generative AI SDK with dynamic Gemma model detection.

## üìù Migration Notes

### For Existing Installations

1. **No Database Migration Required**: SQLite schema unchanged; existing data compatible
2. **Config Update**: Review `mlSystemPrompts` in `botConfig.json` and customize as needed
3. **Model Availability**: Ensure Google Gemini API access is active and API key is valid
4. **Testing**: Run intro command (`!intro`) to verify AI personality and model integration

### Breaking Changes

None. This is a backward-compatible feature release.

## üéØ Testing Coverage

- ‚úÖ 8 tests for Gemini token cleaning functionality
- ‚úÖ 19 tests for song AI command helper
- ‚úÖ 33/40 MachineLearningService tests passing (7 pre-existing failures unrelated to migration)
- ‚úÖ Full TokenService test suite with time formatting edge cases
- ‚úÖ DatabaseService with song play history recording and retrieval

## üîÆ Future Considerations

- Monitor Gemma model performance and quality metrics
- Consider storing more context history if token limits allow
- Potential for song recommendation features using play history data
- Advanced analytics dashboard for DJ and song popularity tracking

## üìö Documentation

- Updated system prompts documentation for Gemma model specifics
- Token system reference with all available tokens and custom token creation
- DatabaseService usage examples for song tracking and history queries
- Configuration guide for timezone, locale, and personality customization

## üôè Contributors

Development and testing across multiple hangout sessions with community feedback integration.
