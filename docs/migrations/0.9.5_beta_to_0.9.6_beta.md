# Migrating from 0.9.5_beta to 0.9.6_beta

This migration guide outlines the steps required to upgrade your bot from version 0.9.5_beta to 0.9.6_beta. The primary changes involve migrating from more capable Gemini models to the free-tier Gemma models, which requires significant prompt updates to maintain quality responses.

## Overview of Changes

The transition from Gemini to Gemma models represents a strategic shift toward sustainable, free-tier AI usage. However, Gemma models are considerably simpler and less sophisticated than their Gemini counterparts. They require **significantly more explicit instructions** to produce consistent, high-quality responses. Think of it as the difference between giving detailed, step-by-step instructions to a competent employee versus a new intern‚Äîthe simpler model needs much more guidance.

### Why Prompts Must Change

**Gemini Models (Previous)**
- More capable at inferring intent from less explicit instructions
- Better at maintaining complex personalities with subtle hints
- Can work with abstract or poetic language more effectively
- Understand nuanced context with fewer examples

**Gemma Models (New)**
- Require explicit, detailed instructions for everything
- Need concrete examples and specific formatting guidance
- Work better with direct language and clear constraints
- Benefit from breaking complex tasks into discrete steps
- Require more emphasis on what NOT to do

## Required Migration Steps

### 1. Shut Down the Running Application

Stop your bot instance to prevent any interference with configuration changes:

```bash
# If running via Docker
docker-compose down

# Or if running locally
pkill -f "node src/index.js"
```

### 2. Install Dependencies

Update npm dependencies to ensure `better-sqlite3` and all other packages are properly installed:

```bash
npm install
```

This will:
- Install any new dependencies required for 0.9.6_beta
- Compile `better-sqlite3` for your system
- Ensure all existing dependencies are up to date

**Local Setup Requirements:**
- **macOS**: If you don't have Xcode Command Line Tools, run: `xcode-select --install`
- **Linux**: Ensure build tools are installed: `sudo apt-get install build-essential`
- **Docker**: Already included; no action needed

### 3. Delete the SQLite Database (only required if migrating from 0.9.5_beta)

The database from 0.9.5_beta is compatible with 0.9.6_beta, but starting fresh ensures a clean state:

```bash
rm ./data/mrroboto.db
```

This removes historical data:
- Song play history
- DJ Ids

This should be safe to do as it wasn't being used for anything yet, and with the change in formats it's simpler just to start the DB again. THe file will be recreated when the application starts


### 4. Update Configuration Prompts

This is the most critical step. Update your `botConfig.json` file with the new prompts designed for Gemma models. Open `data/botConfig.json` and replace the `Instructions` and `mlQuestions` sections.

This can be done using the commands as normal after the Bot is started, but you might find it easier to update them all directly in the config

#### Example Changes: MLPersonality

**Before (0.9.5_beta - Gemini)**
```json
"MLPersonality": "You are the host of a social music room called {hangoutName} where other people take it in turns playing songs. You should adopt the personality of an upbeat radio DJ called {botName}."
```

**After (0.9.6_beta - Gemma)**
```json
"MLPersonality": "## Role: {botName}
You are the host of a social music room called {hangoutName} where other people take it in turns playing songs. You have the persona of a radio DJ called {botName}.
**MANDATE**: Do not describe your personality. Embody it through your reaction to the music."
```

**Key Changes:**
- ‚úÖ Explicit callout of Role
- ‚úÖ not using vauge descriptions like Hangout
- ‚úÖ Clear mandate about embodying vs. describing personality
- ‚úÖ Removed abstract phrasing; using concrete states

#### Example Changes: MLInstructions

**Before (0.9.5_beta - Gemini)**
```json
"MLInstructions": "When asked about dates or facts about artists or music you should verify all facts with reputable sources such as Wikipedia and MusicBrainz"
```

**After (0.9.6_beta - Gemma)**
```json
"MLInstructions": "## DJ Logic & Instructions
**STRICT VARIETY**: 
- You MUST NOT use the history as a template for future responses
- Take extra care NEVER to reuse adjectives when describing users**FORBIDDEN**: No sound effects.
**VERIFY FACTS**: You MUST verify all facts with services such as Wikipedia or Musicbrainz

## Context
**Current Time**: {currentTime} on {currentDayOfWeek}
**Current Date**: {currentDate}, {locale}
**Users Present**: {userlist}"
```

**Key Changes:**
- ‚úÖ Added explicit variety requirements (MUST NOT reuse adjectives, etc.)
- ‚úÖ Clear "FORBIDDEN" section
- ‚úÖ Explicit context section with all available tokens
- ‚úÖ Strong language (MUST, STRICT) instead of suggestions

#### Example Changes: introQuestion

**Before (0.9.5_beta - Gemini)**
```json
"introQuestion": "Introduce the song {trackName} by {artistName} being played by {username}. Keep it under 150 words."
```

**After (0.9.6_beta - Gemma)**
```json
"introQuestion": "## Task
- You MUST NOT use the history as a template for the response

**Dynamic Syntax**: Alternate your opening style. Pick one of the following 4 options
- Start with a direct question about the song.
- Start with a raw reaction to the previous track's ending.
- Start with a detail about the year the song was released.
- Start with a comment about the user

**EXECUTION STEPS**:
1. Introduce the song "{trackName}" by "{artistName}", as requested by the "{username}" using your current persona in the style of a radio DJ
2. The Blend: Integrate a unique fact about the artist or song naturally into your opening thought.
3. The Contrast: If the difference is notable, compare the energy of this track to the previous songs. {last5plays}. Use descriptive adjectives for the sound, not just the 'vibe'.
**CONSTRAINTS**: Max 150 words."
```

**Key Changes:**
- ‚úÖ Added "Task" header for clarity
- ‚úÖ Explicit "Do NOT use history as template" at the start
- ‚úÖ Enumerated opening options (4 specific choices)
- ‚úÖ Numbered execution steps (1-3) instead of vague guidance
- ‚úÖ Guidance on adjectives (descriptive, not just "vibe")
- ‚úÖ Hard constraint on word count

### Pattern Summary: What Makes Gemma-Friendly Prompts

| Aspect | Gemini-Style | Gemma-Style |
|--------|-------------|-----------|
| Instructions | Gentle suggestions | Strong directives (MUST, MUST NOT) |
| Constraints | Implied limits | Explicit boundaries with examples |
| Structure | Flowing narrative | Numbered/bulleted with headers |
| Tone | Abstract/poetic | Concrete/specific |
| Examples | Minimal | Extensive with counter-examples |
| Clarity | Trust inference | Over-communicate intent |

### 5. Restart the Application

After updating the configuration, start the bot:

```bash
# If using Docker
docker-compose up -d

# Or if running locally
npm start
```

The bot will:
- Recreate the SQLite database (if deleted)
- Load the new configuration with updated prompts
- Discover available Gemma models from the Google Gemini API
- Create a fresh conversation history with the new model chain

## Verification Steps

After upgrading, verify that everything is working correctly:

1. **Check Bot Initialization**
   - Look for log entries indicating successful Gemma model detection
   - Should see: `ü§ñ [MachineLearningService] Loaded X available text generation models`

2. **Test ML Commands**
   - Use `!intro` to test the new intro prompt
   - Try `!popfacts`, `!whatyear`, `!meaning`, and `!bandinfo` commands
   - Responses should use the new Gemma-optimized prompts

3. **Verify Configuration**
   - Check that custom tokens and timezone are being applied correctly
   - Run a time-dependent command during different hours to verify mood shifts

4. **Monitor Logs**
   - Check for any Gemma model fallback behavior
   - Ensure no "Unable to get response" errors are common

## Rollback Instructions

If you need to revert to 0.9.5_beta:

1. Restore your backed-up `botConfig.json` with the original prompts
2. Restart the application‚Äîit will work with Gemini models (if your API key permits)
3. The SQLite database is compatible, so no migration needed

## Configuration Template

For reference, here's the template `botConfig.json` structure for 0.9.6_beta. Customize the values to match your hangout:

```json
{
  "botData": {
    "CHAT_AVATAR_ID": "bot-1",
    "CHAT_NAME": "HangBot",
    "CHAT_COLOUR": "00ccff"
  },
  "Instructions": {
    "MLPersonality": "## Role: {botName}\nYou are the host of a social music room called {hangoutName} where other people take it in turns playing songs. You have the persona of a radio DJ called {botName}.\n**MANDATE**: Do not describe your personality. Embody it through your reaction to the music.",
    "MLInstructions": "## DJ Logic & Instructions\n**STRICT VARIETY**: \n- You MUST NOT use the history as a template for future responses\n- Take extra care NEVER to reuse adjectives when describing users\n**FORBIDDEN**: No sound effects.\n**VERIFY FACTS**: You MUST verify all facts with services such as Wikipedia or Musicbrainz\n\n## Context\n**Current Time**: {currentTime} on {currentDayOfWeek}\n**Current Date**: {currentDate}, {locale}\n**Users Present**: {userlist}"
  },
  "configuration": {
    "timezone": "Europe/London",
    "locale": "en-GB",
    "dateFormat": "DD/MM/YYYY",
    "timeFormat": "24"
  },
  "editableMessages": {
    "welcomeMessage": "Hi {username}, welcome to {hangoutName}",
    "nowPlayingMessage": "{username} is now playing {trackName} by {artistName}",
    "justPlayedMessage": "{username} played...\n{trackName} by {artistName}\nStats: üëç {likes} üëé {dislikes} ‚ù§Ô∏è {stars}"
  },
  "mlQuestions": {
    "popfactsQuestion": "## Task\nTell me three short interesting facts about the song and/or the artist {trackName} by {artistName}.\n- When searching note that it may or may not be a cover version\n- Do not tell me that you're giving me three facts as part of the reply\n- **Format:** Limit response to 200 words",
    "whatyearQuestion": "## Task\nTell me what year was the song {trackName} by {artistName} originally released?\n- You MUST cite your source\n- **Format:** Limit response to 50 words",
    "meaningQuestion": "## Task\nTell me the meaning of the lyrics of the song {trackName} by {artistName}\n- **Format:** Limit response to 200 words",
    "bandQuestion": "## Task\nTell me some interesting information about the band or artist called {artistName}.\n**Suggested information to include**\n- when and where they formed\n- when their first and most notable or recent releases were plus how well these releases performed in the charts in both the UK and USA\n- notable former band members\n- **Format:** Limit response to 300 words",
    "introQuestion": "## Task\nIntroduce the song {trackName} by {artistName} as chosen by {username}\n1. Verify song facts using MusicBrainz/Wikipedia.\n2. Comment on how this fits the current vibe and previously played songs.\n- **Format:** Limit response to 150 words"
  },
  "disabledCommands": [],
  "disabledFeatures": [],
  "customTokens": {},
  "mlConversationHistory": []
}
```

**Note:** Customize the following values for your specific hangout:
- `CHAT_NAME`: Your bot's display name
- `CHAT_COLOUR`: Hex color code for the bot's appearance
- `timezone`: Set to your hangout's timezone (e.g., "America/Chicago", "Australia/Sydney")
- `locale`: Set to your hangout's language/region (e.g., "en-US", "en-GB")
- `welcomeMessage`, `nowPlayingMessage`, `justPlayedMessage`: Customize message templates as needed
- Add custom tokens for dynamic personalization (e.g., `{location}`, `{hangoutDescription}`)

## Support & Troubleshooting

### Common Issues

**Q: Bot is returning empty responses**
- A: Gemma models may struggle with the inherited prompts. Review the configuration examples and ensure all `{token}` placeholders are properly defined.

**Q: Model fallback is happening frequently**
- A: Check your Google API key permissions. Ensure you have sufficient quota for the Gemma models.

**Q: Time-based personality isn't changing**
- A: Verify that `{currentTime}` token is working by checking logs. Confirm timezone is set correctly in configuration.

**Q: Prompts aren't being updated in responses**
- A: Clear any cached responses. Restart the bot after configuration changes.

## Additional Resources

- [Google Gemma Model Documentation](https://ai.google.dev/gemma/docs)
- [Prompt Engineering for Gemma Models](https://ai.google.dev/gemma/docs/prompt-structure)
- [Bot Configuration Guide](../CHAT_COMMANDS.md)
- [Changelog for 0.9.6_beta](../changelog/0.9.6_beta.md)
